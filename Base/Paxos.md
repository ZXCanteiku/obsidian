## Paxos
aliases: 
	- "Paxos"

---

# Paxos

**Paxos** — самый ранний из широко известных строгих консенсусных протоколов, предложенный Лэслом Лампортом (Leslie Lamport). В классической форме описывает решение задачи single-decree consensus (одно решение), а на практике используется улучшенная версия (**Multi-Paxos**), которая позволяет согласовать _не один_, а _последовательность_ значений (например, для лога репликации).

## Ключевые роли в Paxos

1. **Proposer (предлагающий)** — узел, который «инициирует» новое решение (предлагает значение). Часто в оптимизированных реализациях есть _выбранный лидер_, играющий роль главного Proposer’а.
2. **Acceptor (принимающий)** — узлы, которые получают предложение от Proposer и «голосуют» за него, при этом соблюдая некоторые правила, чтобы не выбрать два противоречивых значения.
3. **Learner (наблюдатель)** — узел, который просто узнаёт окончательное решение (например, получает «полезную нагрузку» или присваивает её в состоянии БД), но не участвует в «голосовании».

На практике один и тот же физический узел может играть сразу все три роли, просто логически они разделены.

## Принцип работы (упрощённо)

1. **Номера раундов (proposal number)**. Proposer генерирует уникальный номер «раунда» (иногда называемый ballot). Чем больше номер, тем «новее» предложение.
2. **Фаза 1: Prepare**
    - Proposer рассылает Acceptor’ам сообщение «Prepare(n)», где `n` — номер раунда.
    - Каждый Acceptor гарантирует, что не будет отвечать на предложения с номером **меньше**, чем `n`. Он присылает Proposer’у информацию о том, **какое самое последнее предложение** (если было) он уже «получил и (предварительно) принял».
3. **Фаза 2: Accept**
    - Получив ответы, Proposer решает, какое _значение_ предложить. Если acceptor’ы уже приняли какое-то предыдущее предложение с номером < n, Proposer обязан продолжить то же значение, у которого самый большой номер среди ранее принятых. Если же ничего раньше не было, Proposer может предлагать своё новое значение.
    - Proposer рассылает «Accept(n, value)» с номером `n` и выбранным значением. Acceptor’ы принимают (accept), если они ещё не видели большего номера.
    - Если в итоге большинство Acceptor’ов «приняло» это предложение, оно считается окончательно выбранным.

**Кворум** в Paxos обычно — большинство (более половины) узлов. Так гарантируется, что любые два «большинства» пересекаются хотя бы в одном узле, и этот узел не даст появиться второму противоречивому значению, если уже принял первое.

## Multi-Paxos

- Поверх single-decree Paxos строится последовательность согласованных решений (слотов) в журнале.
- Обычно выбирается _лидер_, который делает «Фазу 1» один раз, а затем «штампует» записи (Фаза 2) в быстрых шагах.
- При сбое лидера узлы запускают новую «Фазу 1» с более высоким номером (ballot) и выбирают нового лидера.

## Сложности Paxos

- Оригинальные статьи Лампорта написаны довольно «математически» и трудно воспринимаются.
- На практике Paxos требует аккуратной реализации, особенно при смене лидера, добавлении/удалении узлов.
- Тем не менее Paxos — «золотой стандарт» консенсусных протоколов: доказано, что он корректен, если большинство узлов работоспособно.

---
Tags: #highLoad #develop #coherence  #consensus
Author: [[]]
Related: [[Консенсусные протоколы]]
URL: -- 