## Двухфазная блокировка (2PL)
aliases: 
	- "двухфазная блокировка (2PL)"

---

### Двухфазная блокировка (2PL)

Двухфазная блокировка (2PL) — один из самых популярных алгоритмов сериализуемости в базах данных, который используется уже более 30 лет. 2PL не следует путать с двухфазной фиксацией транзакций (2PC)
#### Основные принципы 2PL

2PL запрещает одновременные конкурентные записи и чтение одного объекта несколькими транзакциями. При этом чтение объекта транзакцией возможно, если объект не записывается другой транзакцией. Запись объекта же требует монопольного доступа. Например:

- Если транзакция A читает объект, а транзакция B хочет записать его, B должна подождать завершения A.
- Если транзакция A записывает объект, а транзакция B хочет его прочитать, B должна подождать завершения A.

Это обеспечивается путем блокировки объекта. Важно, что блокировки могут быть либо разделяемыми (для чтения), либо монопольными (для записи).

#### Реализация двухфазной блокировки

Для реализации 2PL на уровне транзакций в СУБД, например, MySQL (InnoDB) или SQL Server, используется механизм блокировок. Принцип работы следующий:

1. Перед чтением объекта транзакция устанавливает разделяемую блокировку, которая позволяет нескольким транзакциям читать объект, но не разрешает записи.
2. Перед записью объекта транзакция устанавливает монопольную блокировку, при которой никакая другая транзакция не может читать или записывать этот объект.
3. Транзакция может повысить блокировку с разделяемой до монопольной при необходимости.

Двухфазная блокировка делится на две фазы:

- **Первая фаза**: транзакция захватывает необходимые блокировки.
- **Вторая фаза**: транзакция освобождает блокировки при завершении.

#### Проблемы производительности

Основной недостаток 2PL — это низкая производительность, особенно при высоком уровне конкуренции. Когда две транзакции пытаются получить доступ к одному объекту, одна из них должна ждать завершения другой, что снижает степень параллелизма. Также, если одна транзакция занимает много времени, это может замедлить всю систему.

Медленная работа может возникать из-за взаимных блокировок (deadlock), когда две транзакции ожидают друг друга. База данных должна обнаружить и прервать одну из транзакций, что требует повторного выполнения действий. Это вызывает дополнительные затраты.

#### Предикатные блокировки

Для предотвращения гонок данных и фантомов в 2PL можно использовать предикатные блокировки. Они блокируют не конкретный объект, а все объекты, удовлетворяющие определенному условию (например, все бронирования в определённом временном интервале).

Пример:

```sql
SELECT * FROM bookings 
WHERE room_id = 123 AND end_time > '2018-01-01 12:00' AND start_time < '2018-01-01 13:00';

```

Если транзакция хочет заблокировать объекты, удовлетворяющие этому запросу, она устанавливает предикатную блокировку, и если другая транзакция уже заблокировала объекты, подходящие под этот запрос, первая должна подождать завершения второй.

#### Блокировки по диапазону значений индекса

Для повышения производительности предикатных блокировок многие базы данных реализуют блокировки по диапазону значений индекса. Это упрощает задачу, блокируя не только точные объекты, но и более широкий диапазон, что уменьшает время ожидания.

Например, при блокировке бронирований на определённое время можно расширить блокировку на все залы в этом временном интервале, что позволяет ускорить работу системы при большом количестве записей.

### Заключение

Двухфазная блокировка обеспечивает сериализуемость, предотвращая гонки данных и гарантируя корректность транзакций, однако она может существенно снижать производительность системы. Применение предикатных блокировок и блокировок по диапазону значений индекса помогает решить проблему с производительностью, хотя не исключает возникновения взаимных блокировок и необходимости повторного выполнения транзакций.

---
Tags: #transactions #highLoad
Author: [[]]
Related: [[Сериализуемость]]
URL: -- 