### Модель памяти в Java:

aliases: 
	- "Модель памяти в Java"

**гарантия выполнения кодам
1. Java дает гарантию _[as-if-serial](https://en.wikipedia.org/wiki/As-if_rule)_ выполнения кода — вне зависимости от используемой JDK итоговый результат выполнения будет не отличим от такого порядка, как если бы действия выполнялись действительно последовательно согласно порядку в коде
2. Процессоры тоже делают только такие переупорядочивания, которые не изменят итогового результата выполнения инструкций
3. Процессоры имеют Cache Coherence механизм, который гарантирует консистентность данных среди локальных кэшей: как только значение попадает в локальный кэш одного ядра, оно будет видно всем остальным ядрам
4. 
**Из неочевидного:**
1. Java дает _as-if-serial_ гарантию только для единственного треда в изоляции. Это означает, что в многопоточной программе при работе с shared данными мы можем не увидеть записи там, где полагаемся на порядок выполнения действий в коде другого треда. Другими словами, для первого треда в изоляции валидно переупорядочивать инструкции местами, если это не повлияет на _его_ результат выполнения, но переупорядочивание может повлиять на _другие_ треды
2. Процессор также дает гарантию только для единственного ядра в изоляции
3. Cache Coherence действительно гарантирует чтение актуальных значений, но пропагация записи происходит не мгновенно, а с некоторой задержкой


**_Instructions reordering_**. Оба треда могут поменять местами инструкции записи и чтения, так как эти действия никак не связаны.
**_Visibility_**. Даже если переупорядочивания не было, записи могут быть просто не видны другому треду из-за оптимизаций компилятора или задержки при пропагации записи на уровне кеша.

#### Java Memory Model
- Разрешает выполнение различных оптимизаций компилятора, JVM или процессора.
- Строго закрепляет условия, при которых программа считается правильно синхронизированной, и закрепляет поведение правильно синхронизированных программ.
- Описывает отношение между высокоуровневым кодом и памятью.
- Является trade-off между строгостью исполнения кода и возможными оптимизациями.
По умолчанию JMM разрешает любые переупорядочивания и не гарантирует видимости изменений. Однако _при выполнении определенных условий_ нам гарантируется порядок действий,


#### Memory Ordering
**Memory Ordering** описывает _наблюдаемый программой_ порядок, в котором происходят действия с памятью.

_Memory Model_ описывает, какие переупорядочивания возможны. В зависимости от строгости модели памяти подразделяются на следующие типы:
1. _Sequential Consistency_: запрещены все переупорядочивания
2. _Relaxed Consistency_: разрешены некоторые переупорядочивания
3. _Weak Consistency_: разрешены все переупорядочивания


#### Sequential Consistency
**Sequential Consistency Model (SC)** — это очень строгая модель памяти, которая гарантирует отсутствие переупорядочиваний.
Java Memory Model — это **Sequential Consistency-Data Race Free (SC-DRF)** модель: нам предоставляется sequential consistency, но только в том случае, если мы избавимся от всех _data race_ в программе

**[[hapens-before]]**
**[[Cache Coherence]]**


---
Tags: #thread
Author: [[]]
Related: [[Многопоточность]]
URL: https://habr.com/ru/articles/685518/