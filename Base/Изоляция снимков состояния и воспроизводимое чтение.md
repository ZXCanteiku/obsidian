## Изоляция снимков состояния и воспроизводимое чтение
aliases: 
	- "изоляция снимков состояния и воспроизводимое чтение"

---

### Изоляция снимков состояния и воспроизводимое чтение

Уровень изоляции [[Чтение зафиксированных данных]] помогает избежать многих проблем конкурентного доступа, таких как прерывание транзакций, предотвращение чтения промежуточных результатов и смешивание операций записи. Однако при этом уровне возможны аномалии, например, **[[Невоспроизводимое чтение]]** (**Неповторяющееся чтение**). Это **случается, когда данные читаются внутри транзакции, и пока эта транзакция выполняется, другая транзакция изменяет те же самые записи**.

#### Ситуации, требующие более строгой изоляции

Некоторые операции требуют согласованности данных на момент начала запроса:

1. **Резервное копирование** — Если данные меняются в процессе создания резервной копии, результат может быть неполным или несогласованным.
2. **Аналитические запросы и проверки целостности** — Такие запросы часто просматривают большие объемы данных и нуждаются в целостности результатов.

#### Изоляция снимков состояния

**Изоляция снимков состояния** позволяет каждой транзакции читать данные из согласованного снимка состояния базы на момент её начала. Это значит, что транзакция видит только зафиксированные данные на конкретный момент времени, даже если позже они изменились. Такой подход полезен для долгих операций чтения, как резервное копирование и аналитика, потому что данные не меняются в течение выполнения запроса.

Эта изоляция реализуется с помощью многоверсионного управления конкурентным доступом (**[[MVCC]]**), применяемого в таких СУБД, как PostgreSQL, MySQL (InnoDB), Oracle и SQL Server.

#### Как работает [[MVCC]]

MVCC хранит несколько версий объектов, что позволяет избежать блокировок на чтение и запись. Пример работы MVCC:

1. Каждая транзакция получает уникальный идентификатор, а записанные данные помечаются им.
2. При удалении объект не стирается сразу, а помечается идентификатором удаляющей транзакции.
3. Постепенно помеченные данные удаляются сборщиком мусора, когда другие транзакции не нуждаются в них.

#### Правила видимости для согласованных снимков

Чтобы транзакции видели согласованные данные, соблюдаются следующие правила:

1. Транзакция игнорирует изменения других транзакций, начатых позже нее.
2. Изменения прерванных транзакций также игнорируются.
3. Записи, созданные завершившимися транзакциями до начала текущей, видимы.

Такой подход позволяет системе обеспечить согласованные снимки состояния даже при долгих транзакциях с минимальными затратами на управление версиями объектов.

#### Индексы и изоляция снимков состояния

В многоверсионных базах данных индексы могут работать по-разному. Один подход — указание индекса на все версии объекта, при этом запрашивая только те, которые доступны текущей транзакции. Старые, более не используемые версии объектов и их индексы удаляются процессом сборки мусора.

В PostgreSQL, например, используются улучшения, позволяющие не обновлять индекс, если несколько версий одного объекта находятся на одной странице, что повышает производительность.

Некоторые базы данных, такие как CouchDB, Datomic и LMDB, применяют B-деревья с подходом «дописывание данных/копирование при записи». Вместо перезаписи страниц создается новая версия измененной страницы, и родительские страницы обновляются до корневой. Это позволяет избежать изменений в старых данных, а новые корневые вершины создают согласованный снимок базы на момент транзакции. Однако такой подход требует фоновой оптимизации и очистки данных.

#### Воспроизводимое чтение и терминологическая путаница

Изоляция снимков состояния удобна для чтения, но названия уровня различаются. Oracle называет этот уровень "сериализация", тогда как PostgreSQL и MySQL — "воспроизводимым чтением". Это связано с тем, что SQL-стандарт не учитывает изоляцию снимков, ориентируясь на старые уровни изоляции.

Хотя PostgreSQL и MySQL используют термин "воспроизводимое чтение" для соответствия стандарту, реализованные гарантии различаются. Определения уровней изоляции в SQL стандарте неточны, что приводит к неоднозначности их интерпретаций. Например, в DB2 IBM воспроизводимое чтение называют сериализуемостью. Это создает путаницу, и четкого определения воспроизводимого чтения до сих пор не существует.

---
Tags:  #transactions #highLoad
Author: [[]]
Related: [[Слабые уровни изоляции]]
URL: -- 