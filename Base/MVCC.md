## MVCC
aliases: 
	- "MVCC"

---

### Как работает MVCC

Базы данных применяют для реализации изоляции снимков состояния обобщение механизма, действие которого по части предотвращения «грязных» операций чтения мы наблюдали на рис. 7.4. БД должна хранить для этого несколько различных зафиксированных версий объекта, поскольку разным выполняемым транзакциям может понадобиться состояние базы на различные моменты времени. Вследствие хранения одновременно нескольких версий объектов этот метод получил название многоверсионного управления конкурентным доступом (multiversion concurrency control, MVCC).
Если базе необходима только изоляция уровня чтения зафиксированных данных, но не уровня изоляции снимков состояния, достаточно было бы хранить только две версии объекта: зафиксированную версию и перезаписанную, но еще не зафиксированную версию. Однако поддерживающие изоляцию снимков состояния подсистемы хранения обычно используют MVCC и для изоляции уровня чтения зафиксированных данных. При этом обычно при чтении таких данных применяется отдельный снимок состояния для каждого запроса, а при изоляции снимков состояния — один и тот же снимок состояния для всей транзакции. Рисунок 7.7 иллюстрирует реализацию изоляции снимков состояния на основе MVCC в СУБД PostgreSQL [31] (другие реализации аналогичны). В самом начале выполнения транзакция получает уникальный, монотонно возрастающий1 идентификатор транзакции (txid). При каждой записи транзакцией записываемые в базу данные помечаются номером этой транзакции.

![[Pasted image 20241114210215.png]]

В каждой строке таблицы есть поле created_by, содержащее идентификатор транзакции, вставившей эту строку в таблицу. Более того, в каждой строке таблицы есть поле deleted_by, изначально пустое. Если транзакция удаляет строку, то строка на самом деле не удаляется из базы данных, а помечается для удаления путем установки значения этого поля в соответствии с идентификатором запросившей удаление транзакции. В дальнейшем, когда уже никакая транзакция точно не обратится к удаленным данным, процесс сборки мусора БД удалит все помеченные для удаления строки и освободит занимаемое ими место. Обновление превращается внутри базы данных в удаление и создание. Например, на рис. 7.7 транзакция 13 снимает $100 со счета 2, изменяя баланс с $500 на 400. Таблица accounts после этого содержит две строки для счета 2: строку с балансом $500, помеченную как удаленную транзакцией 13, и созданную транзакцией 13 строку с балансом $400.

---
Tags:
Author: [[]]
Related: [[]]
URL: -- 