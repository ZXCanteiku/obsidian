## Как реализовывать Rate limit
aliases: 
	- "ratelimit"

---

###  Основные цели rate limit

- **Защита от перегрузок и DoS-атак.** Ограничение числа запросов предотвращает исчерпание ресурсов и снижает нагрузку на серверы.
- **Оптимизация использования ресурсов.** Сокращение лишних вызовов помогает экономить бюджет, особенно при работе с платными API.
- **Предотвращение злоупотреблений.** Гибко настраиваемые правила позволяют фильтровать запросы по IP, идентификаторам пользователей и другим характеристикам.

---

### Алгоритмы ограничения трафика

1. **[[Token Bucket (маркерная корзина)]]:**
    - _Принцип:_ Корзина заполняется маркерами с заданной скоростью. Каждый запрос «съедает» один маркер.
    - _Плюсы:_ Гибкость, возможность обработки кратковременных всплесков.
    - _Минусы:_ Тонкая настройка параметров (ёмкость и скорость пополнения).
2. **[[Leaky Bucket (дырявое ведро)]]:**
    - _Принцип:_ Запросы помещаются в очередь и обрабатываются с фиксированной скоростью, избыточные – отклоняются.
    - _Плюсы:_ Стабильная скорость обработки.
    - _Минусы:_ Очередь может переполниться при резком всплеске трафика.
3. **[[Fixed Window Counter (счётчик фиксированных интервалов)]]:**
    - _Принцип:_ Счетчик запросов обнуляется через фиксированные промежутки времени.
    - _Плюсы:_ Простота реализации.
    - _Минусы:_ Возможны всплески запросов на границах интервалов.
4. **[[Журнал скользящих интервалов]]**
5. **[[Счетчик скользящих интервалов]]**

---

### Реализация с использованием Redis
- **Основные команды:**
    - `INCR` – атомарное увеличение счетчика.
    - `EXPIRE` – установка срока жизни ключа для автоматического сброса счетчика.
- **Особенности распределённой среды:**
    - Возможны гонки при параллельном доступе к счетчику.
    - Решения: использование Lua-скриптов или упорядоченных множеств для обеспечения атомарности операций.

---

### Архитектура и интеграция

- **Позиционирование сервиса:**
    - Может быть реализован как отдельный промежуточный слой (например, в API-шлюзе) или непосредственно на стороне API-сервера.
- **Интерфейс взаимодействия:**
    - Используйте HTTP REST или gRPC для получения запросов на проверку лимита.
    - Возвращайте код 429 с заголовками:
        - **X-Ratelimit-Limit:** максимально допустимое количество запросов.
        - **X-Ratelimit-Remaining:** оставшееся количество запросов.
        - **X-Ratelimit-Retry-After:** время до сброса лимита.
- **Интеграция с Istio:**
    - При использовании Istio можно настроить EnvoyFilter, который перенаправляет запросы к вашему сервису лимитирования.

---

### Мониторинг и масштабирование

- **Мониторинг:**
    - Отслеживайте количество блокируемых и разрешённых запросов.
    - Анализируйте корректность настроенных правил, чтобы не блокировать легитимные запросы.
- **Масштабирование:**
    - В распределённых системах применяйте централизованное хранилище (например, Redis) для синхронизации лимитов между несколькими серверами.

---
Tags: #solution
Author: [[]]
Related: [[Распространённые решения]]
URL: -- 