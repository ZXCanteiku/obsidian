aliases: 
	- "Первый уровень кэша"
### Первый уровень кэша (Session Cache)
- **Контекст сессии:** При создании объекта `Session` создаётся собственный контекст кэша. Этот контекст представляет собой простую хэш-таблицу, где ключом выступает идентификатор сущности (чаще всего класс + первичный ключ), а значением — сам объект.
- **Сессия как единица работы:** В рамках одной сессии Hibernate обеспечивает единообразие объектов — несколько запросов на одну и ту же сущность вернут один и тот же экземпляр в памяти. Это предотвращает состояние «разбросанных» объектов, позволяя отслеживать изменения и контролировать транзакции.
- **Жизненный цикл объектов в первом уровне кэша:**
    - `Transient`: Объекты, ещё не сохранённые в базе, не кэшируются.
    - `Persistent`: После сохранения или загрузки объект попадает в сессию.
    - `Detached`: При закрытии сессии объекты теряют связь с контекстом, а их копии остаются за пределами кэша первого уровня.

**Кэш первого уровня в Hibernate** привязан к объекту `Session` и является изолированным для каждой отдельной сессии.
### Работа кэша первого уровня в параллельных транзакциях
**Изоляция сессий и транзакций:**
- **Изолированность кэша:**  
    Каждый объект `Session` имеет свой собственный кэш первого уровня. Это означает, что два параллельных потока, работающих с разными сессиями, не разделяют один и тот же кэш. Данные, загруженные в одном сеансе, недоступны в другом, если их явно не передать.
- **Параллельные транзакции:**
    - Если в приложении запускается несколько транзакций в разных потоках, то, как правило, для каждой транзакции создаётся своя сессия Hibernate.
    - Каждая сессия будет иметь свой независимый кэш первого уровня. Из-за этого изменения, сделанные в одной транзакции, не отражаются автоматически в кэше первой уровня другой сессии.
    - Это гарантирует изолированность и согласованность данных в контексте одной транзакции, но также подразумевает, что каждая сессия может иметь своё представление об одних и тех же данных, которое может отличаться от представления другой сессии до момента синхронизации с базой.

**Взаимодействие транзакций с кэшем первого уровня:**
1. **Начало транзакции:**
    - При открытии новой транзакции обычно открывается новая сессия, и её кэш первого уровня пустой.
    - Запрос на загрузку объекта приводит к обращению к базе данных и сохранению объекта в кэше первой уровня текущей сессии.
2. **Параллельная работа:**
    - В разных транзакциях, использующих разные сессии, Hibernate может загрузить один и тот же объект из базы данных, но в каждом случае этот объект будет храниться в отдельном кэше первой уровня.
    - Если один поток изменит объект и сохранит изменения (например, через `session.saveOrUpdate()` и `transaction.commit()`), эта информация отразится в базе данных.
    - Другой поток, имеющий свою сессию, не узнает об этих изменениях автоматически, пока не выполнит повторный запрос или пока его объекты не станут «устаревшими».
3. **Изоляция и согласованность:**
    - Кэш первого уровня не обеспечивает синхронизации между параллельными сессиями. Каждый сеанс работает с копией данных, которая может быть актуальной на момент загрузки, но может устаревать, если изменения происходят в других транзакциях.
    - Для обеспечения согласованности между транзакциями используются механизмы изоляции транзакций базы данных, а не кэш первого уровня. Например, установка уровня изоляции транзакций (READ COMMITTED, REPEATABLE READ и т.д.) влияет на то, как запросы видят изменения других транзакций.


---
Tags: #cashe
Author: [[]]
Related: [[Кэширование Hibernate]]
URL: [[]]