## Асимметрия записи и фантомы
aliases: 
	- "fсимметрия записи и фантомы"

---

### Асимметрия записи и фантомы

При конкурентных записях в базе данных возможны различные состояния гонки, такие как [[Грязное чтение]] и [[Предотвращение потери обновлений]] . Для сохранения целостности данных важно предотвращать эти состояния, используя блокировки или атомарные операции. Однако существуют и более сложные случаи конфликтов, например асимметрия записи.

#### Пример асимметрии записи: отгулы врачей

Рассмотрим ситуацию, где приложение управляет графиком дежурств врачей, и в каждом дежурстве должно быть хотя бы один врач. Если двое врачей одновременно запрашивают отгулы, оба могут получить разрешение, потому что изначально оба числятся дежурными. Однако результатом будет отсутствие врачей на смене, что нарушает требование.

#### Характеристики асимметрии записи

Асимметрия записи возникает, когда две транзакции читают одни и те же данные и обновляют разные объекты, создавая состояние гонки. Это обобщение проблемы потери обновлений. В случае одновременного обновления одного объекта возникает потеря обновлений, а при разных объектах — асимметрия записи.

Для предотвращения асимметрии записи:

- Атомарные однообъектные операции и автоматическое обнаружение потерь обновлений могут быть недостаточны.
- Сериализуемая изоляция транзакций (доступна в некоторых СУБД) способна предотвратить асимметрию записи.
- Ограничения целостности (например, уникальности) помогают, но требуют поддержки базы для комплексных условий.
- Явная блокировка строк с `FOR UPDATE` может быть эффективна.

Пример запроса для блокировки строк в транзакции:

```sql
BEGIN TRANSACTION;
SELECT * FROM doctors
WHERE on_call = true
AND shift_id = 1234 FOR UPDATE;
UPDATE doctors
SET on_call = false
WHERE name = 'Alice'
AND shift_id = 1234;
COMMIT;

```

#### Другие примеры асимметрии записи

- **Система бронирования**: Проверка наличия свободного времени для бронирования и последующая вставка записи могут создать конфликтующие бронирования.
- **Многопользовательские игры**: Две фигуры могут быть перемещены на одну клетку.
- **Имя пользователя**: Проверка на уникальность имени и его создание могут привести к дублированию.
- **Двойные списания средств**: Проверка доступного баланса перед списанием может не учесть конкурирующие транзакции.

#### Асимметрия записи из-за фантомов

Фантомы — это случай, когда операция записи одной транзакции изменяет результат поиска другой транзакции, вызывая асимметрию записи. Например, операция записи может изменить количество объектов, доступных в выборке, нарушая логику приложения.

#### Материализация конфликтов

Для решения проблемы фантомов можно использовать "материализацию конфликтов". Например, в системе бронирования можно создать таблицу, где каждая запись соответствует залу и времени, блокируя нужные строки для предотвращения конфликта бронирований.

---
Tags: #transactions #highLoad
Author: [[]]
Related: [[Слабые уровни изоляции]]
URL: -- 