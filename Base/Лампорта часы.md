### 1. Общая идея

**Лампорта часы** (Lamport timestamps) — это упрощённый способ «логической нумерации» событий, который тоже гарантирует, что если $A$ причинно предшествует $B$ $(A → B)$, то метка (timestamp) у A меньше, чем у B. Однако лампортовы метки **не** помогают определить, что события конкурентны: они дают **полную** (но лишь приблизительно отражающую причинность) упорядоченность.

### 2. Как работают

1. Каждый узел $i$ хранит **один числовой счётчик** (целое число). Изначально все счётчики $= 0$.
2. Когда на узле $i$ происходит локальное событие (или он отправляет сообщение), он делает $$Li←Li+1$$и считает новое значение своей «лампортовой метки».
3. Если узел $i$ посылает сообщение узлу $j$, он вкладывает в сообщение текущий счётчик $Li$.
4. Когда узел $j$ получает сообщение со значением $t$: $$Lj←max⁡(Lj,t)+1$$то есть он синхронизирует свой счётчик с учётом полученной информации и потом ещё увеличивает на 1.

### 3. Как сравнивать

- Если у события $A$ есть метка $TS(A)$, а у $B$ есть $TS(B)$, и $TS(A)<TS(B)$, то возможно $A→B$ (A действительно случилось до B).
- Если $TS(A)=TS(B)$, то непонятно, конкурируют ли они или одно раньше другого.
- Если $TS(A)<TS(B)$, но сами события могут и **не** быть причинно связаны — просто лампортовы метки всегда задают **полный порядок** (может быть «ложное упорядочение» конкурентных событий).

### 4. Преимущество над векторами

- **Простота хранения**: хранится одно число, а не массив.
- Не нужно знать общее количество узлов. Достаточно уметь при конфликте «узел X» или «узел Y» выбирать, где счётчик больше.

### 5. Недостаток

- Если события конкурентны, Lamport timestamps всё равно одно поставит «раньше», другое «позже». С точки зрения причинности это может ввести в заблуждение (хотя нарушения безопасности не возникает, но теряется точная информация о конкурентности).

---
Использование временных меток Лампорта показано на рис. 1 Каждый узел имеет уникальный идентификатор и хранит счетчик количества обработанных им операций. Временная метка Лампорта — это просто пара типа «счетчик, ID узла». Два узла могут иногда иметь одно и то же значение счетчика, но благодаря ID узла каждая метка времени становится уникальной.
![[Pasted image 20250122203426.png]]
Основная идея временных меток Лампорта, которая делает их совместимыми с причинностью, заключается в следующем: каждый узел и каждый клиент отслеживают максимальное значение счетчика, встречавшееся им до сих пор, и включают данное значение в каждый запрос. Когда узел получает запрос или ответ со значением счетчика, большим, чем его собственное, он немедленно увеличивает свой счетчик до этого максимума.
Поскольку максимальное значение счетчика передается с каждой операцией, эта схема гарантирует, что упорядочение с временными метками Лампорта будет причинно-согласованным: каждая причинная зависимость приводит к увеличению временной метки.