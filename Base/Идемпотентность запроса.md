## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
aliases: 
	- "–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞"

---
–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ ‚Äî —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π —Ç–æ–≥–æ, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏–∑–º–µ–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ API —Å–µ—Ä–≤–∏—Å–∞. –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–ª—é—á–µ–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏) –∏ –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

![[Pasted image 20250205210114.png]]


¬†–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –≤–Ω–µ–¥—Ä–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º —Å –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–æ–π, –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
¬†![[Pasted image 20250205210155.png]]
### –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
–ü—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É, —Å–æ—Å—Ç–æ—è—â—É—é –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤:
1. –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö.
2. –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞. –û–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.
3. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.
4. –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
5. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞, –±–ª–æ–∫ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –ø–æ–∑–≤–æ–ª—è—è –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–∞–º —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–≤–æ—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

### –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —ç—Ç–∞–ø–æ–≤:
1. –ë–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö.
2. –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ –∏–º–µ–µ—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Å–≤—è–∑–∞–Ω —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º, —Ç–æ –±–ª–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç, –æ–±–æ–∑–Ω–∞—á–∞—è —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
3. –î–∞–ª—å–Ω–µ–π—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç, –ø–æ—Å–∫–æ–ª—å–∫—É –∑–∞–ø—Ä–æ—Å —É–∂–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.
![[Pasted image 20250205210910.png]]

### –°–ø–æ—Å–æ–±—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
#### Spring MVC
–° –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–æ–≤
 ![[Pasted image 20250205211339.png]]
 –ü—Ä–∏–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
 ![[Pasted image 20250205211517.png]]

#### –° –ø–æ–º–æ—â—å—é istio

| **–ú–µ—Ç–æ–¥**                                        | –ö–∞–∫ –ø–æ–º–æ–≥–∞–µ—Ç?                          | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?                            |
| ------------------------------------------------ | -------------------------------------- | ---------------------------------------------- |
| **Rate Limiting (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤)** | –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤         | –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã —à–ª—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã                    |
| **Response Caching (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤)**       | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç            | –ï—Å–ª–∏ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ       |
| **Retry Policy (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–∞–º–∏)**          | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Ç—Ä–∞–∏      | –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –∏–Ω–æ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç                      |
| **Header-Based Idempotency (Idempotency-Key)**   | –§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∫–ª—é—á—É | –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
–í **—Å–∞–º–æ–º Istio** **–Ω–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π**, –ø–æ—ç—Ç–æ–º—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è **–≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**.
üí° **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**
1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **—É–Ω–∏–∫–∞–ª—å–Ω—ã–π `Idempotency-Key`** –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ HTTP-–∑–∞–ø—Ä–æ—Å–∞.
2. Istio **–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞**.
3. **–°–µ—Ä–≤–∏—Å** (–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä Envoy) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, **—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–æ—Ç –∫–ª—é—á –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** (Redis, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö).
4. –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç**.
5. –ï—Å–ª–∏ –∫–ª—é—á –Ω–æ–≤—ã–π, **–∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**.

**–ü—Ä–∏–º–µ—Ä:**
``` yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: redis-idempotency
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua
          typed_config:
            "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
            inlineCode: |
              function envoy_on_request(request_handle)
                local redis_host = "redis.default.svc.cluster.local"
                local redis_port = 6379
                local key = request_handle:headers():get("Idempotency-Key")
                
                if key then
                  local redis_query = "GET " .. key
                  local redis_response = request_handle:httpCall("redis", {
                    [":method"] = "POST",
                    [":path"] = "/",
                    [":authority"] = redis_host .. ":" .. redis_port,
                    ["content-length"] = #redis_query,
                    ["content-type"] = "application/x-www-form-urlencoded"
                  }, redis_query, 1000)
                  
                  if redis_response[":status"] == "200" then
                    -- –ï—Å–ª–∏ –∫–ª—é—á –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                    request_handle:respond({[":status"] = "409"}, "Duplicate request detected")
                    return
                  end

                  -- –ï—Å–ª–∏ –∫–ª—é—á –ù–ï –Ω–∞–π–¥–µ–Ω, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –≤ Redis
                  request_handle:httpCall("redis", {
                    [":method"] = "POST",
                    [":path"] = "/",
                    [":authority"] = redis_host .. ":" .. redis_port,
                    ["content-type"] = "application/x-www-form-urlencoded"
                  }, "SET " .. key .. " 1 EX 300", 1000)
                end
              end

```

#### –ù—É–∂–Ω–æ –ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã?
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —á–∞—Å—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑–±—ã—Ç–æ—á–Ω–æ–π, –æ—Å–æ–±–µ–Ω–Ω–æ —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—Ç —Å—Ç—Ä–æ–≥–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã –æ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫.


---
Tags:  #idempotency
Author: [[]]
Related: [[–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è]]
URL: https://habr.com/ru/companies/domclick/articles/779872/