## Алгоритм маркерной корзины
aliases: 
	- ""

---

# Алгоритм маркерной корзины

Алгоритм маркерной корзины довольно популярен. Он простой и понятный, и многие интернет-компании, такие как **Amazon** [5] и **Stripe** [6], используют его для фильтрации API-запросов.

## Как работает алгоритм

Маркерная корзина — это контейнер с заранее определенной емкостью. В нее регулярно помещают маркеры. Когда она окончательно заполняется, маркеры больше не добавляются.

### Основные правила работы:

- Маркерная корзина — это контейнер с заранее определенной емкостью. В нее регулярно помещают маркеры. Когда она окончательно заполняется, маркеры больше не добавляются. На *[рис. 4.4]* показана маркерная корзина с емкостью 4. Наполнитель ежесекундно помещает в корзину 2 маркера. Когда корзина заполняется, последующие маркеры отбрасываются.
- Каждый запрос потребляет один маркер. При поступлении запроса мы проверяем, достаточно ли маркеров в корзине. На [рис. 4.5] показано, как это работает.
	- если маркеров достаточно, мы удаляем по одному из них для каждого запроса, и запрос проходит дальше;.
	- если маркеров недостаточно, запрос отклоняется.

На [рис. 4.6] проиллюстрирована логика траты маркеров, заправки корзины и ограничения трафика. В этом примере корзина вмещает 4 маркера, а скорость заправки равна 2 маркера в минуту.
## Иллюстрации работы алгоритма

### Наполнение корзины
![[Pasted image 20250301201531.png]]

### Проверка наличия маркеров и обработка запросов
![[Pasted image 20250301201541.png]]

### Расход маркеров и ограничение трафика
![[Pasted image 20250301201550.png]]

## Параметры алгоритма

Алгоритм маркерной корзины принимает два параметра:

- **Размер корзины** – максимальное количество маркеров, которое может в ней находиться.
- **Частота пополнения** – количество маркеров, ежесекундно добавляемых в корзину.

## Сколько корзин нужно?

Это зависит от правил ограничения трафика. Вот несколько примеров:

- Для **разных конечных точек API** нужны разные корзины. Например, если пользователь публикует **1 сообщение в секунду**, добавляет **150 друзей в день** и "лайкает" **5 сообщений в секунду**, каждому пользователю нужно выделить **3 корзины**.
- Если требуется **фильтрация по IP-адресам**, каждому IP-адресу требуется **своя корзина**.
- Если система допускает **не больше 10 000 запросов в секунду**, логично предусмотреть **глобальную корзину** для всех запросов.

## Преимущества и недостатки

### Преимущества:

- **Легкая реализация**.
- **Эффективное потребление памяти**.
- **Обработка коротких всплесков трафика** – пока в корзине остаются маркеры, запросы проходят.

### Недостатки:

- Несмотря на простоту (всего два параметра – размер корзины и частота пополнения), **подобрать оптимальные значения может быть непросто**.


---
Tags:  #solution
Author: [[]]
Related: [[Rate limit]]
URL: -- 